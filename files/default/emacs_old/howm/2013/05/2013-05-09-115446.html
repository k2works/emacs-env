<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>2013-05-09-115446.html</title>

</head>

<body>

<h1>= 開発/本番環境構築手順書</h1>

<h2>1) 目的</h2>

<p>継続的インテグレーション環境を構築して高品質で短期的にシステムを開発する環境を構築する  </p>

<h2>2) 前提条件</h2>

<h2>3) インフラ環境の構築</h2>

<h3>3.1) ハードウェア</h3>

<h4>3.1.1) AWS環境の構築</h4>

<ul>
<li>EC2インスタンス作成</li>
<li><p>EBSの作成</p>

<pre><code>$ yum install xfsprogs.x86_64
$ mkfs.xfs /dev/xvdj
$ mount -t xfs -o defaults /dev/xvdj /var/git
</code></pre></li>
<li><p>Elastic IPの割当</p></li>
<li>Route53でホスト名の割当</li>
<li>RDSインスタンスの作成</li>
<li><p>RDSセットアップ</p>

<pre><code>  $ rds-create-db-security-group development
--db-security-group-description 'this RDS is development environments'
  $ rds-authorize-db-security-group-ingress development --cidr-ip
0.0.0.0/0
  $ rds-authorize-db-security-group-ingress development
--ec2-security-group-name web --ec2-security-group-owner-id 262470114399
  $ rds-create-db-instance development --engine MySQL
--engine-version 5.5.27 --db-instance-class db.t1.micro --allocated-storage
5 --master-username dev --master-user-password dev123 --db-security-groups
production --backup-retention-period 3
  $ rds-create-db-parameter-group development -f mysql5.5 -d "DB
Parameter Group for utf8"
  $ rds-modify-db-parameter-group development -p
"name=character_set_client, value=utf8, method=immediate"
  $ rds-modify-db-parameter-group development -p
"name=character_set_connection, value=utf8, method=immediate"
  $ rds-modify-db-parameter-group development -p
"name=character_set_database, value=utf8, method=immediate"
  $ rds-modify-db-parameter-group development -p
"name=character_set_results, value=utf8, method=immediate"
  $ rds-modify-db-parameter-group development -p
"name=character_set_server, value=utf8, method=immediate"
  RDSインスタンスのDB Parameter Groupをdevelopmentに更新
</code></pre></li>
</ul>

<h3>3.2) ソフトウェア(Cent OS 6.3編)</h3>

<h4>3.2.1) OSの設定</h4>

<ul>
<li><p>一般ユーザーの作成</p>

<pre><code>$ useradd -m cent
$ passwd cent
$ /usr/sbin/visudo
 # %wheel ALL=(ALL) ALL
 #をとる
$ gpasswd -a cent wheel
</code></pre></li>
<li><p>sshログイン設定</p></li>
<li>起動スクリプトの追加</li>
<li>.ec2ディレクトリの作成</li>
<li>認証ファイルのコピー</li>
<li>ec2-api-toolsのコピー</li>
<li><p>perlのインストール</p>

<pre><code>  yum install perl
</code></pre></li>
<li><p>jdkのインストール</p>

<pre><code>  yum list \*java-1\* | grep open
  yum install java-1.7.0-openjdk.x86_64
</code></pre></li>
<li><p>起動時に実行するようにする</p>

<pre><code>  /etc/init.d/ec2
  $ chkconfig --add ec2
  $ chkconfig ec2 on
</code></pre>

<p>起動スクリプトを実行してEBSバックアップをとるとログインできなくなる</p></li>
</ul>

<h4>3.2.2) ミドルウェアの設定</h4>

<h5>3.2.2.1) RDMSの構築</h5>

<ul>
<li><p>MySQLサーバのセットアップ</p>

<pre><code>  $ sudo yum install expect
  $ mkpasswd
  パスワード
  mzH6bS1x- (hcoss_product)
  55Hmh0;ks (hcoss_development)
  % sudo -s
  % echo "mzH6bS1x-" &gt; /root/mysql_hcoss_product_password
  % echo "55Hmh0;ks" &gt; /root/mysql_hcoss_development_password
  % chmod 400 /root/mysql_*_password
  % exit
</code></pre></li>
<li><p>接続の確認</p>

<pre><code>  mysql -h development.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com
-P 3306 -u dev -p
  Enter password:dev123
  パスワードの変更はAWSコンソールから実行する
  mysql -h development.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com
-P 3306 -u dev -p
  Enter password:55Hmh0;ks
</code></pre></li>
</ul>

<h5>3.2.2.2) プロジェクト管理ツールの構築</h5>

<ul>
<li><p>Aluminiumが保存されるディレクトリをマウントする</p>

<pre><code>   var/opt/alminium
</code></pre>

<p>アクセスができなくなるのでやめる       </p></li>
<li><p>Aluminumインストール</p>

<pre><code>  $ yum install git 
  $ git clone [https://github.com/alminium/alminium.git]
  $ cd alminium
  $ bash ./smelt
</code></pre></li>
<li><p>インストール後にapacheが起動しない場合</p>

<pre><code>  $ sudo service httpd start
  Starting httpd: httpd: Syntax error on line 221 of
/etc/httpd/conf/httpd.conf: Syntax error on line 1 of
/etc/httpd/conf.d/redmine.conf: Cannot load
/usr/lib64/ruby/gems/1.9.1/gems/passenger-4
0.2/ext/apache2/mod_passenger.so into server:
/usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0
2/ext/apache2/mod_passenger.so: cannot open shared object file: No such
file or directory
                                                     [FAILED]
  $ sudo find / -type f -name mod_passenger.so
  $ sudo cp usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/libout/apache2/mod_passenger.so /usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/ext/apache2                $ sudo cp usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/libout/apache2/mod_passenger.so /usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/ext/apache2
</code></pre></li>
<li><p>プロジェクトの登録</p>

<pre><code>  $ git config --global http.sslverify false
  $ git clone [https://dev.k2-works.net/git/hcoss]
   ここで聞かれるパスワードはalminumで登録した情報（サーバOSのユーザではない）
</code></pre></li>
</ul>

<h5>3.2.2.3) SCMの構築</h5>

<ul>
<li><p>Gitユーザーの作成         </p>

<pre><code> まずリモートマシンにgitユーザーを作成します。
 $ sudo useradd -m -d /var/git git
 $ sudo passwd git
 $ sudo chmod 750 /var/git
 $ sudo gpasswd -a git apache
</code></pre></li>
<li><p>Gitレポジトリの設定       </p>

<pre><code> ローカルマシンからあなたのSSH公開鍵をgitユーザーのホームディレクトリに転送します。
 $ scp -i k2works.pem /.ssh/id_rsa.pub git@dev.k2-works.net:
 SSH公開鍵をauthorized_keysに加えます。
 $ cat id_rsa.pub &gt;&gt; .ssh/authorized_keys
 $ rm id_rsa.pub
 $ sudo mkdir --mode=700 var/git.ssh
 $ sudo cp .ssh/authorized_keys var/git.ssh/
 $ sudo chown -R git:git var/git.ssh
 ローカルマシンからrailsユーザーとしてSSHで接続し、パスワードを尋ねられないことを確認します。
 % ssh git@dev.k2-works.net
 リポジトリへのシンボルリンクを作成する
 $ ln -s var/opt/alminium/git/hcoss hcoss.git
</code></pre></li>
</ul>

<h5>3.2.2.4) CIサーバの構築</h5>

<h6>3.2.2.4.1) 自動テスト</h6>

<h6>3.2.2.4.1.1) Railsプロジェクトの作成</h6>

<ul>
<li><p>node.jsインストール
[Mac OS X と homebrew なら驚くほど簡単に node.js で HelloWorld]</p>

<pre><code>$ruby -e "$(curl -fsSkL raw.github.com/mxcl/homebrew/go)"
$brew install node
</code></pre></li>
<li><p>Railsのインストール     </p></li>
<li><p>RSpecのインストール
[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル]</p>

<p>Gemfile</p>

<pre><code>group :test, :development do
 gem 'rspec-rails', '~&gt;2.0'
end


$bundle install
$rails generate rspec:install
$rake db:create
$rake db:migrate
$rake spec
</code></pre>

<p>.rspecを直下に作成する</p></li>
<li><p>-color</p></li>
<li><p>Cucumberのインストール</p>

<p>Gemfile</p>

<pre><code>group :test, :development do
 gem 'rspec-rails', '~&gt;2.0'
 gem 'cucumber-rails"
end     


$bundle install
$rails generate cucumber:install
$rake db:migrate
$rake db:test:prepare
$rake spec
$rake cucumber
</code></pre>

<p>[Mac OS X と homebrew なら驚くほど簡単に node.js で HelloWorld]: http://takatamajp.wordpress.com/2012/11/17/install<em>nodejs</em>on<em>mac</em>os<em>x</em>using_homebrew/
[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル]: http://qiita.com/items/bf1bc376d88186050f3f</p></li>
</ul>

<h6>3.2.2.4.1.1.1) Capybara-webkitのインストール</h6>

<ul>
<li><p>QTライブラリのインストール</p>

<p>[RSpecとCapybaraでJavaScript/Ajaxをテストする] </p>

<pre><code>$brew install qt
</code></pre></li>
<li><p>Capybara-webkitのインストール</p>

<p>Mac環境ではheadlessはいらない
   サーバーにはインストールすること</p></li>
<li><p>CentOS6.3の場合</p>

<pre><code> [Installing Qt and compiling capybara webkit]
 [CentOS6.3 の Jenkins 上で jasmine-headless-webkit を走らせる]
 rpm -i [http://dl.atrpms.net/el6-x86\_64/atrpms/stable/atrpms-repo-6-6.el6.x86\_64.rpm]              rpm -i [http://dl.atrpms.net/el6-x86\_64/atrpms/stable/atrpms-repo-6-6.el6.x86\_64.rpm]
 yum install --enablerepo=atrpms-testing qt47-webkit-devel
 export QMAKE=/usr/bin/qmake-qt47
 cd /usr/bin
 sudo ln -s qmake-qt47 qmake
 sudo ln -s qmake-qt47 qmake-qt4


 group :test, :development do
  gem 'rspec-rails','~&gt;2.0'
  gem 'database_cleaner'
 end 
group :test do
  gem 'headless'
  gem 'capybara-webkit'
end 
$bundle install
</code></pre>

<p>spec/spec_helper.rb</p>

<pre><code>config.before(:suite) do
 DatabaseCleaner.strategy = :truncation
 DatabaseCleaner.clean_with(:truncation)
end


config.before(:each) do
 DatabaseCleaner.start
end
config.after(:each) do
 DatabaseCleaner.clean
end
Capybara.javascript_driver = :webkit
$ rake spec
</code></pre>

<p>[RSpecとCapybaraでJavaScript/Ajaxをテストする]: http://www.oiax.jp/rails/zakkan/testing<em>javascript</em>with<em>rspec</em>and<em>capybara.html
 [Installing Qt and compiling capybara webkit]: https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit
 [CentOS6.3 の Jenkins 上で jasmine-headless-webkit を走らせる]: http://tomykaira.hatenablog.com/entry/2012/07/27/103122
 [http://dl.atrpms.net/el6-x86_64/atrpms/stable/atrpms-repo-6-6.el6.x86_64.rpm]: http://dl.atrpms.net/el6-x86</em>64/atrpms/stable/atrpms-repo-6-6.el6.x86_64.rpm</p></li>
</ul>

<h6>3.2.2.4.1.1.2) テストサーバー</h6>

<ul>
<li><p>Sport</p>

<p>[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル（その２）]</p>

<pre><code>$ vim Gemfile
</code></pre>

<p>Gemfile</p>

<pre><code>group :test, :development do
 gem 'rspec-rails','~&gt;2.0'
 gem 'database_cleaner'
 gem 'spork','0.9.2'
end


spork --bootstrap
$ vim spec/spec_helper.rb
</code></pre>

<p>一通りSpork.prefork do・・・endに入れる</p>

<pre><code>require 'rubygems'
require 'spork'
#uncomment the following line to use spork with the debugger
#require 'spork/ext/ruby-debug'
Spork.prefork do
# Loading more in this block will cause your tests to run faster.
However,
  # if you change any configuration or code from libraries loaded here,
you'll
  # need to restart spork for it take effect.
  # This file is copied to spec/ when you run 'rails generate
rspec:install'
  ENV["RAILS_ENV"] ||= 'test'
  require File.expand_path("../../config/environment", FILE
  require 'rspec/rails'
  require 'rspec/autorun'
  # Requires supporting ruby files with custom matchers and macros, etc,
  # in spec/support/ and its subdirectories.
  Dir[Rails.root.join("spec/support/**/*.rb")].each {|f| require f}
  RSpec.configure do |config|
  # ## Mock Framework
  #
  # If you prefer to use mocha, flexmock or RR, uncomment the appropriate
line:
  #
  # config.mock_with :mocha
  # config.mock_with :flexmock
  # config.mock_with :rr
  # Remove this line if you're not using ActiveRecord or ActiveRecord
fixtures
  config.fixture_path = "#{::Rails.root}/spec/fixtures"
  # If you're not using ActiveRecord, or you'd prefer not to run each of
your
  # examples within a transaction, remove the following line or assign
false
  # instead of true.
  config.use_transactional_fixtures = true
  # If true, the base class of anonymous controllers will be inferred
  # automatically. This will be the default behavior in future versions of
  # rspec-rails.
  config.infer_base_class_for_anonymous_controllers = false
  end
  end
  Spork.each_run do
  # This code will be run each time you run your specs.
  end
  $ vim .rspec
  .rspec
</code></pre></li>
<li><p>-colour</p></li>
<li><p>-drb</p>

<pre><code> $ spork
</code></pre>

<p>[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル（その２）]: http://qiita.com/items/fbe0a4ac2269a743dc17</p></li>
</ul>

<h6>3.2.2.4.1.1.3) jenkinsのインストール</h6>

<pre><code>  Jenkins Update
  [http://d.hatena.ne.jp/tadasy/20111109/1320842690]
  [http://shogogg.hatenablog.jp/entry/20120410/1334048401]
  wget [http://mirrors.jenkins-ci.org/war/latest/jenkins.war]
  sudo service jenkins stop
  sudo rm usr/lib/jenkins/jenkins.war     sudo mv jenkins.war
/usr/lib/jenkins
  sudo service jenkins start
</code></pre>

<h6>3.2.2.4.1.1.4) RailsをビルドするためのJenkinsセットアップ</h6>

<ul>
<li><p>RVMの設定</p>

<p>[Ubuntu Server 12.04 LTS + RVM + ruby1.9 + Rails3の環境を構築してみた]</p></li>
<li><p>RVMのインストール</p>

<p>[さくらVPS/CentOS 6.3 Ruby 1.93/RVMのインストール手順Railsサーバへの道]</p>

<pre><code>bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )        bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )
rvm pkg install libyaml
rvm remove 1.9.1    
rvm install ruby-1.9.3 -C --with-opt-dir=$HOME/.rvm/usr
</code></pre></li>
<li><p>Git Plugin</p></li>
<li>RVM Plugin</li>
<li>Rake Plugin</li>
<li>Jenkins及びプラグインの設定</li>
<li>gitの設定</li>
<li>Git pluginの設定</li>
<li>Rakeの設定（空欄のまま）</li>
<li>E-mail通知の設定</li>
</ul>

<h6>3.2.2.4.1.1.5) Railsをビルドするジョブを作成する</h6>

<ul>
<li><p>jenkinsからgitにアクセスできるようにする</p>

<pre><code>この辺は曖昧
$ qpasswd -a jenkins apcach
$ qpasswd -a jenkins git
では、jenkinsユーザでsshキーの作成を行います
</code></pre>

<p>[ Jenkins@さくらVPSにOctopressのデプロイを任せてみる]</p>

<pre><code>$ cd /var/lib/jenkins
$ sudo -u jenkins -H /usr/bin/git config --global user.email "kakimomokuri@gmail.com"
$ sudo -u jenkins -H /usr/bin/git config --global user.name "k2works"
$ sudo -u jenkins -H ssh-keygen -t rsa -C kakimomokuri@gmail.com
cat var/lib/jenkins.ssh/id_rsa.pub &gt;&gt; var/git.ssh/authorized_key
cp .ssh/known_hosts var/lib/jenkins.ssh/
</code></pre></li>
<li><p>Rake Pluginを使ってビルドする</p></li>
<li><p>シェルスクリプトを使ってビルドする</p>

<pre><code>gem install bundle --no-ri --no-rdoc
bundle install
rake db:setup
rake spec
</code></pre>

<p>[ Jenkins@さくらVPSにOctopressのデプロイを任せてみる]: http://www.tokoro.me/2012/07/29/jenkins-octopress/    </p></li>
</ul>

<h6>3.2.2.4.2) コードインスペクション</h6>

<h6>3.2.2.4.2.1) コードカバレッジ分析</h6>

<ul>
<li><p>Gemをインストールする</p>

<pre><code>group :test do
 #ローカル開発では使わない
 # gem 'headless'
 gem 'capybara-webkit'
 gem 'simplecov', :require =&gt; false
 gem 'simplecov-rcov', :require =&gt; false
end
</code></pre></li>
<li><p>spec/spec_helpler.rbの頭に追加</p>

<pre><code>require 'simplecov'
require 'simplecov-rcov'
SimpleCov.formatter = SimpleCov::Formatter::RcovFormatter
SimpleCov.start 'rails'
</code></pre></li>
<li><p>.gitignoreにcoverage追加</p></li>
<li><p>Ruby metrics plugin</p>

<p>ビルド後の処理の追加   </p></li>
</ul>

<h6>3.2.2.4.2.2) コード品質の検査</h6>

<ul>
<li><p>rails<em>best</em>practicesをGemに追加</p>

<pre><code> group :test, :development do
  gem 'rspec-rails','~&gt;2.0'
  gem 'database_cleaner'
  gem 'spork','0.9.2'
  gem 'rails_best_practices', :require =&gt; false
end
</code></pre></li>
<li><p>rails<em>bes</em>practices.sh追加</p></li>
<li><p>ビルド手順の追加からシェルの実行を追加</p>

<p>bash script/rails<em>best</em>paractices.sh</p></li>
<li><p>Plot Plugin</p>

<p>ビルド後の処理でビルドデータをプロットを追加</p></li>
<li><p>.gitignoreにreportsを追加</p></li>
</ul>

<h6>3.2.2.4.2.3) 重複コード（コピー＆ペースト）の検出</h6>

<p>[CentOSにAntをインストールする]</p>

<ul>
<li>pmdインストール     </li>
<li>sudo apt-get install ant</li>
<li>tools/build.xml追加</li>
<li><p>DRY Plugin</p>

<p>ビルド手順の追加からAntの呼び出しを追加
   ビルド後の処理に重複コード分析の集計を追加</p></li>
<li><p>.gitignoreへの追加</p>

<p>tools/pmd/doc</p>

<p>[CentOSにAntをインストールする]: http://blog.justoneplanet.info/2010/12/03/centos%E3%81%ABant%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B/</p></li>
</ul>

<h6>3.2.2.4.3) ドキュメント生成</h6>

<h6>3.2.2.4.3.1) Ruby,Railsでのドキュメント生成</h6>

<ul>
<li><p>YARDを使ってドキュメントを生成し、閲覧できるようにする</p>

<pre><code>group :test, :development do
 gem 'rspec-rails','~&gt;2.0'
 gem 'database_cleaner'
 gem 'spork','0.9.2'
 gem 'rails_best_practices', :require =&gt; false
 gem 'yard', :require =&gt; false
end
</code></pre></li>
<li><p>HTML Publisher Plugin</p>

<p>ビルド手順の追加からシェルの実行を選択して yard doc
   ビルド後の処理の追加からPublish HTML Reports追加</p></li>
</ul>

<h6>3.2.2.4.3.2) Ruby,Railsでのデプロイ</h6>

<ul>
<li>新しいジョブを作るblog_deploy</li>
<li>ソースコード管理システムはblogジョブと同様に設定する</li>
<li>ビルド・トリガセクション内で他のプロジェクトのビルド後にビルドにチェックを入れる</li>
<li>Run the build in a RVM-managed environmentもblogジョブと同様に設定しておく</li>
<li>ビルドのセクションではシェルスクリプトの実行を選びcap deployを入力する** デプロイ</li>
</ul>

<h6>3.2.2.4.4) 分散ビルド</h6>

<ul>
<li>自動テストとコードインスペクションの分割</li>
<li>自動テストの種類での分割</li>
<li><p>ビルドフローの起点の設定とフローに潜む問題の解決</p>

<p>Jenkins Parameterized Trigger plugin
  Join plugin
  Build Pipeline Plugin</p></li>
</ul>

<h4>3.2.3) アプリケーションの設定</h4>

<h5>3.2.3.1) ステージング環境の構築</h5>

<ul>
<li>Railsアプリケーションのセットアップ    </li>
<li><p>railsユーザーの作成</p>

<pre><code>$ sudo useradd -m -d /var/rails rails
$ sudo passwd rails
$ sudo chmod 750 /var/rails
railsユーザーをgitグループに加えます。/var/opt/aluminum/gitディレクトリの読み取り権限が与えられることになります。            railsユーザーをgitグループに加えます。/var/opt/aluminum/gitディレクトリの読み取り権限が与えられることになります。
読み取り権限変更を忘れるとwebからアクセスできないので注意！
$ sudo gpasswd -a rails git
$ sudo gpasswd -a rails apache
</code></pre></li>
<li><p>Apache実行ユーザーをグループに追加</p>

<pre><code>% sudo gpasswd -a apache rails
</code></pre></li>
<li><p>RVMのインストール</p>

<pre><code>$ yuml install libtool
$ yuml install bison
[さくらVPS/CentOS 6.3 Ruby 1.93/RVMのインストール手順Railsサーバへの道]
bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )            bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )
rvm pkg install libyaml
rvm install ruby-1.9.3 -C --with-opt-dir=$HOME/.rvm/usr
railsユーザーがrvmを使っていない場合は
.bashrc
source "$HOME/.rvm/scripts/rvm"
追加
</code></pre>

<p>[今更ながらubuntu11.10にrvmを入れたので忘れないようにメモ]</p></li>
<li><p>各種パッケージのインストール</p>

<pre><code>$ yum update
$ yum -y install gcc gcc-c++ autoconf git
$ yum -y install openssl-devel zlib-devel readline-devel curl-devel gettext-devel
$ yum -y install httpd-devel sqlite-devel
</code></pre></li>
<li><p>libyamlのインストール</p>

<pre><code>$ cd /usr/local/src
$ wget [http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz]
$ tar xzf yaml-0.1.4.tar.gz
$ cd yaml-0.1.4
$ ./configure
$ make &amp;&amp; make install
</code></pre></li>
<li><p>SELinuxの無効化</p>

<p>aluminumがやってる</p>

<pre><code>$ setenforce 0
</code></pre>

<p>エディタで /etc/sysconfig/selinux を開き、 <br />
  SELINUX=enforcing
  を
  SELINUX=disabled
  に変更してください。</p></li>
<li><p>staging環境のデータベースの準備</p>

<pre><code> mysql&gt; CREATE DATABASE hcoss_staging DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
 mysql&gt; GRANT ALL ON hcoss_staging.* TO 'hcoss'@'localhost';
 mysql&gt; SET PASSWORD FOR 'hcoss'@'localhost' = PASSWORD('55Hmh0;ks');
 mysql&gt; alter database hcoss_staging default character set utf8;
 mysql&gt; show variables like '%character%';
 exit
</code></pre></li>
<li><p>Gemfileの追加</p>

<pre><code>Gemfileを追加して、bundle installを実行。
group :deployment do
# Capistraono (Deploy支援)
  gem 'capistrano'
  gem 'capistrano-ext'
  gem 'capistrano_colors'
  gem 'rvm-capistrano'
end
# メンテナンスモード画面の表示
gem 'turnout'
</code></pre></li>
<li><p>Capistranoの設定フィルを生成</p>

<pre><code>$ capify .
続いて、staging環境/production環境専用のCapistrano設定ファイルを作成。
mkdir config/deploy
touch config/deploy/staging.rb
touch config/deploy/production.rb
</code></pre></li>
<li><p>Capistrano共通のデプロイ設定</p>

<pre><code>config/deploy.rb
</code></pre></li>
<li><p>Capistrano Staging環境のデプロイ設定</p>

<pre><code>config/deploy/staging.rb
</code></pre></li>
<li><p>Capistrano Producion環境のデプロイ設定</p>

<pre><code>config/deploy/production.rb
</code></pre></li>
<li><p>メンテナンス画面の設定</p>

<pre><code>config/maintenace.yml
</code></pre></li>
<li><p>DB設定</p>

<pre><code>database.yml
</code></pre></li>
<li><p>デプロイ前のチェックリスト</p></li>
<li>deploy.rb, staging.rb, production.rbのパラメータをすべて設定したかチェック</li>
<li>ステージングDB、本番DBの設定をdatabase.ymlに追加しているか？</li>
<li>デプロイ用Gitリポジトリのブランチが最新の状態か？</li>
<li><p>デプロイ手順</p>

<pre><code>cap staging deploy:setup
cap staging deploy
cap production deploy:setup
cap production deploy      
is not in the sudoers fileと出たときは
visudoで
rails   ALL=(ALL)    ALLを追加
</code></pre></li>
<li><p>Apachバーチャルホストを設定</p>

<pre><code>ステージング環境ではRailsEnvに注意すること
sudo vi /etc/httpd/conf/httpd.conf
#ServerName centossrv.com:80行頭に#を追加してコメントアウト
NameVirtualHost *:80コメント解除(バーチャルホスト有効化)
sudo vi /etc/httpd/conf.d/vhost.conf
&lt;VirtualHost *:80&gt;
  &lt;Location /&gt;
    &lt;IfModule mod_deflate.c&gt;
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        Header append Vary User-Agent env=!dont-vary
    &lt;/IfModule&gt;
  &lt;/Location&gt;
  ServerName hcoss.dev.k2-works.net
  ServerAlias *.dev.k2-works.net
  DocumentRoot var/rails/hcoss/current/public
  RailsEnv staging
  PassengerEnabled on
  RemoveHandler .cgi .php
&lt;/VirtualHost&gt;


$ apachectl cofigtest
</code></pre>

<p>[さくらVPS/CentOS 6.3 Ruby 1.93/RVMのインストール手順Railsサーバへの道]: http://morizyun.github.io/blog/rvm-install-centos-ruby-rails/
  [今更ながらubuntu11.10にrvmを入れたので忘れないようにメモ]: http://d.hatena.ne.jp/zizgig/20120512/1336826698</p></li>
</ul>

<h5>3.2.3.2) 本番環境の構築</h5>

<h2>4) SCMの構築</h2>

<ul>
<li>gitインストール</li>
</ul>

<h2>5) プロジェクト管理ツールの構築</h2>

<pre><code>[高校生になって初めてスクラムを始めました～「ストーリー」で何を作るかまとめよう]
</code></pre>

<ul>
<li><p>Aluminumインストール</p>

<pre><code>$ yum install git 
$ git clone [https://github.com/alminium/alminium.git]
$ cd alminium
$ bash ./smelt
</code></pre></li>
<li><p>インストール後にapacheが起動しない場合</p>

<pre><code>$ sudo service httpd start
Starting httpd: httpd: Syntax error on line 221 of
/etc/httpd/conf/httpd.conf: Syntax error on line 1 of
/etc/httpd/conf.d/redmine.conf: Cannot load
/usr/lib64/ruby/gems/1.9.1/gems/passenger-4
0.2/ext/apache2/mod_passenger.so into server:
/usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0
2/ext/apache2/mod_passenger.so: cannot open shared object file: No such
file or directory
                                                     [FAILED]
$ sudo find / -type f -name mod_passenger.so
 $ sudo cp usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/libout/apache2/mod_passenger.so /usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/ext/apache2        $ sudo cp usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/libout/apache2/mod_passenger.so /usr/lib64/ruby/gems/1.9.1/gems/passenger-4.0.2/ext/apache2
</code></pre>

<p>[高校生になって初めてスクラムを始めました～「ストーリー」で何を作るかまとめよう]: http://www.atmarkit.co.jp/fjava/rensai4/scrum01/01.html</p></li>
</ul>

<h2>6) アプリケーションの構築</h2>

<h3>6.1) サーバ設定</h3>

<ul>
<li><p>EC2インスタンスセットアップ</p>

<p>[CentOS用 Nginx起動スクリプト]
  起動スクリプトの追加（EIP割当）</p>

<p>[CentOS用 Nginx起動スクリプト]: http://pirosikick.hateblo.jp/entry/20101019/1287502384</p></li>
</ul>

<h3>6.2) DB設定</h3>

<ul>
<li><p>RDSセットアップ</p>

<pre><code>$ rds-create-db-security-group development --db-security-group-description 'this RDS is development environments'
$ rds-authorize-db-security-group-ingress development --cidr-ip 0.0.0.0/0
$ rds-authorize-db-security-group-ingress development --ec2-security-group-name web --ec2-security-group-owner-id 262470114399
$ rds-create-db-instance development --engine MySQL --engine-version 5.5.27 --db-instance-class db.t1.micro --allocated-storage 5 --master-username dev --master-user-password dev123 --db-security-groups production --backup-retention-period 3
</code></pre>

<p>[ AWS RDSのMysql設定がインスタンス立ち上げた状態ではUTF-8になってなく、文字化けで困った時の対処メモ]</p>

<pre><code>$ rds-create-db-parameter-group development -f mysql5.5 -d "DB Parameter Group for utf8"
$ rds-modify-db-parameter-group development -p "name=character_set_client, value=utf8, method=immediate"
$ rds-modify-db-parameter-group development -p "name=character_set_connection, value=utf8, method=immediate"
$ rds-modify-db-parameter-group development -p "name=character_set_database, value=utf8, method=immediate"
$ rds-modify-db-parameter-group development -p "name=character_set_results, value=utf8, method=immediate"
$ rds-modify-db-parameter-group development -p "name=character_set_server, value=utf8, method=immediate"
</code></pre>

<p>RDSインスタンスのDB Parameter Groupをdevelopmentに更新</p></li>
<li><p>MySQLサーバのセットアップ</p>

<pre><code>$ sudo yum install expect
$ mkpasswd
パスワード
mzH6bS1x- (hcoss_product)
55Hmh0;ks (hcoss_development)
% sudo -s
% echo "mzH6bS1x-" &gt; /root/mysql_hcoss_product_password
% echo "55Hmh0;ks" &gt; /root/mysql_hcoss_development_password
% chmod 400 /root/mysql_*_password
% exit
</code></pre></li>
<li><p>接続の確認</p>

<pre><code>mysql -h development.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com -P 3306 -u dev -p
Enter password:dev123
パスワードの変更はAWSコンソールから実行する
mysql -h development.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com -P 3306 -u dev -p
Enter password:55Hmh0;ks
</code></pre>

<p>[ AWS RDSのMysql設定がインスタンス立ち上げた状態ではUTF-8になってなく、文字化けで困った時の対処メモ]: http://qiita.com/items/341ca51b4f8a510b60ba</p></li>
</ul>

<h3>6.3) プロジェクトのチェックアウト(ローカル開発環境）</h3>

<ul>
<li>プロジェクトの作成</li>
<li>ユーザーの登録</li>
<li><p>プロジェクトのチェックアウト</p>

<p>ALMiniumでは、認証機関に署名されていないSSL証明書を利用するので、SSLで利用する証明書による検証を無効にする必要があります。</p>

<pre><code>$ git config -global http.sslverify false 
$ git clone [https://dev.k2-works.net/git/hcoss]
</code></pre></li>
<li><p>railsアプリケーションの作成</p>

<p>チェックアウトしたプロジェクトに移動後以下のコマンドを実行</p>

<pre><code>$ rails new .
$ git add .
$ git commit -a
$ git push -u origin master
</code></pre></li>
</ul>

<h3>6.4) Railsアプリケーション設定(サーバー環境）</h3>

<h4>6.4.1) ステージング環境の構築</h4>

<ul>
<li><p>サーバーの準備（Cent OS 6.3編）  </p>

<p>EC2インスタンスを構築時に完了</p></li>
<li><p>Ruby 1.9.3のインストール</p>

<p>Aluminumインストール時に完了</p></li>
<li><p>各種パッケージのインストール</p>

<p>[サーバーの準備（CentOS 6.2編）]</p>

<pre><code>$ yum update
$ yum -y install gcc gcc-c++ autoconf git
$ yum -y install openssl-devel zlib-devel readline-devel curl-devel gettext-devel
$ yum -y install httpd-devel sqlite-devel
</code></pre></li>
<li><p>libyamlのインストール</p>

<pre><code>$ cd /usr/local/src
$ wget [http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz]
$ tar xzf yaml-0.1.4.tar.gz
$ cd yaml-0.1.4
$ ./configure
$ make &amp;&amp; make install
</code></pre></li>
<li><p>SELinuxの無効化</p>

<pre><code>$ setenforce 0
エディタで /etc/sysconfig/selinux を開き、
SELINUX=enforcing
を
SELINUX=disabled
に変更してください。
</code></pre></li>
<li><p>ファイアウォールの設定</p>

<p>system-config-firewall-tui コマンドを実行
  「カスタマイズ」を選択
  「WWW(HTTP)」を選択して「閉じる」
  「OK」を選択</p></li>
<li><p>一般ユーザーの作成</p></li>
<li>Railsアプリケーションのセットアップ</li>
<li><p>railsユーザーの作成</p>

<pre><code>% sudo useradd -m -d /var/rails rails
% sudo passwd rails
% sudo chmod 750 /var/rails
</code></pre></li>
<li><p>Apache実行ユーザーをグループに追加</p>

<pre><code>% sudo gpasswd -a apache rails
</code></pre></li>
<li><p>RVMのインストール</p>

<pre><code>[さくらVPS/CentOS 6.3 Ruby 1.93/RVMのインストール手順Railsサーバへの道]
bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )            bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )
rvm pkg install libyaml
rvm install ruby-1.9.3 -C --with-opt-dir=$HOME/.rvm/usr
</code></pre></li>
<li><p>ApacheとPhusion Passengerのセットアップ</p>

<p>Aluminumインストール時に完了</p></li>
<li><p>データベースとの接続（MySQL編）</p></li>
<li><p>データベース接続の切り替え</p>

<pre><code>% sudo su - rails
% cd railsdemo
エディタで Gemfile を開き、
gem 'sqlite3'
を
gem 'mysql2'
に変更します。そして、Bundlerでmysql2ライブラリをインストールします。
% bundle install
config/database.yml
production:
 adapter: mysql2
 database: railsdemo_production
 username: railsdemo
 password: diiNv2bid4aTI
 host: 127.0.0.1
 encoding: utf8
% RAILS_ENV=production rake db:schema:load
% RAILS_ENV=production rake db:seed
</code></pre></li>
<li><p>Railsアプリケーションの再起動</p>

<pre><code>% touch tmp/restart.txt
</code></pre></li>
<li><p>日本語対応</p>

<pre><code>[Amazon RDS 文字化けと格闘]
mysql&gt; alter database development default character set utf8;
mysql&gt; show variables like '%character%';
railsユーザーになってサイドDB migrateb% RAILS_ENV=production rake db:schema:load
% RAILS_ENV=production rake db:seed
</code></pre></li>
<li><p>Gitレポジトリの作成</p></li>
<li><p>Gitレポジトリの作成</p>

<pre><code>まずリモートマシンにgitユーザーを作成します。
$ sudo useradd -m -d /var/git git
$ sudo passwd git
$ sudo chmod 750 /var/git
$ sudo gpasswd -a git apache
railsユーザーをgitグループに加えます。/var/opt/aluminum/gitディレクトリの読み取り権限が与えられることになります。            railsユーザーをgitグループに加えます。/var/opt/aluminum/gitディレクトリの読み取り権限が与えられることになります。
$ sudo gpasswd -a rails git
$ sudo gpasswd -a rails apache
ローカルマシンからあなたのSSH公開鍵をgitユーザーのホームディレクトリに転送します。
$ scp -i k2works.pem /.ssh/id_rsa.pub git@dev.k2-works.net:
SSH公開鍵をauthorized_keysに加えます。
$ cat id_rsa.pub &gt;&gt; .ssh/authorized_keys
$ rm id_rsa.pub
$ sudo mkdir --mode=700 var/git.ssh
$ sudo cp .ssh/authorized_keys var/git.ssh/
$ sudo chown -R git:git var/git.ssh
ローカルマシンからrailsユーザーとしてSSHで接続し、パスワードを尋ねられないことを確認します。
% ssh git@dev.k2-works.net
リポジトリへのシンボルリンクを作成する
$ ln -s var/opt/alminium/git/hcoss hcoss.git
</code></pre></li>
<li><p>Capistranoによるデプロイ</p></li>
<li><p>SSH公開鍵の設置</p>

<pre><code>$ sudo mkdir --mode=700 var/rails.ssh
$ sudo cp home/k2works.ssh/authorized_keys var/rails.ssh/
$ sudo chown -R rails:rails var/rails.ssh
ローカルマシンからrailsユーザーとしてSSHで接続し、パスワードを尋ねられないことを確認します。
% ssh rails@railsdemo.k2-works.net
</code></pre></li>
<li><p>Capistranoの準備</p>

<pre><code>% gem install capistrano
% capify .


config/deploy.rb


 require 'bundler/capistrano'
load 'deploy/assets'
set :application, "railsdemo"
set :deploy_to, "/var/rails/railsdemo"
set :user, "rails"
set :use_sudo, false
set :local_repository, "git@demo.k2-works.net:railsdemo.git"
set :repository, "/var/git/railsdemo.git"
set :branch, "master"
set :scm, :git
set :deploy_via, :remote_cache
set :normalize_asset_timestamps, false
set :keep_releases, 3
role :web, "demo.k2-works.net"
role :app, "demo.k2-works.net"
role :db,  "demo.k2-works.net", :primary =&gt; true
after "deploy:update", :roles =&gt; :app do
  run "cp #{shared_path}/config/database.yml
#{release_path}/config/"
end
after "deploy:update", "deploy:cleanup"
namespace :deploy do
  desc "Restarts your application."
  task :restart, :roles =&gt; :app do
    run "touch #{current_path}/tmp/restart.txt"
  end
end
</code></pre>

<p>次のコマンドを実行します</p>

<pre><code>% cap deploy:setup
</code></pre>

<p>エディタで Gemfile を開き、gem 'sqlite3' の部分を gem 'mysql2' あるいは gem
  'pg' と書き換えます。また、
    # gem 'therubyracer'
    を次のように書き換えます。</p>

<pre><code>gem 'therubyracer', :platform =&gt; :ruby
$bundle install
railsユーザーでリモートホストにログインして以下のコマンドを順に実行します。
$ cd /var/rails/railsdemo/shared
$ mkdir config
</code></pre>

<p>MySQLを利用している場合は、新規ファイル
  /var/rails/railsdemo/shared/config/database.yml を次の内容で作成します。</p>

<pre><code> production:
 adapter: mysql2
 database: railsdemo_production
 username: railsdemo
 password: diiNv2bid4aTI
 host: railsdemo.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com                                  host: railsdemo.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com
 encoding: utf8
$ cap deploy
</code></pre></li>
<li><p>仮想ホストの設定変更</p>

<p>sudo権限のあるユーザー(kuroda)でリモートホストにログインして、/etc/httpd/sites-available/railsdemo を次のように修正します（要sudo）。                            sudo権限のあるユーザー(kuroda)でリモートホストにログインして、/etc/httpd/sites-available/railsdemo を次のように修正します（要sudo）。</p>

<pre><code>&lt;VirtualHost *:80&gt;
 ServerName asagao.oiax.jp
 DocumentRoot /var/rails/railsdemo/current/public
 RackEnv production
 &lt;Directory /var/rails/railsdemo/current/public&gt;
 AllowOverride all
 Options -MultiViews
 &lt;/Directory&gt;
 &lt;/VirtualHost&gt;
</code></pre>

<p>パスの /public の前に current を追加しています（2カ所）。
   そして、Apacheをリロードします。</p>

<pre><code>$ sudo service apache2 reload # Ubuntu Server 12.04/10.04
</code></pre>

<p>LTS の場合               </p></li>
<li><p>ステージング環境の設定</p>

<p>[Rails本番環境構築ガイド]
   [Capistrano 複数環境へのデプロイ]</p></li>
<li><p>staging環境のデータベースの準備</p>

<pre><code>mysql&gt; CREATE DATABASE hcoss_staging DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
mysql&gt; GRANT ALL ON hcoss_staging.* TO 'hcoss'@'localhost';
mysql&gt; SET PASSWORD FOR 'hcoss'@'localhost' = PASSWORD('55Hmh0;ks');
mysql&gt; alter database hcoss_staging default character set utf8;
mysql&gt; show variables like '%character%';
exit
</code></pre></li>
<li><p>Gemfileの追加</p>

<pre><code>Gemfileを追加して、bundle installを実行。
group :deployment do
# Capistraono (Deploy支援)
  gem 'capistrano'
  gem 'capistrano-ext'
  gem 'capistrano_colors'
  gem 'rvm-capistrano'
end
# メンテナンスモード画面の表示
gem 'turnout'
</code></pre></li>
<li><p>Capistranoの設定フィルを生成</p>

<pre><code>$ capify .
続いて、staging環境/production環境専用のCapistrano設定ファイルを作成。
mkdir config/deploy
touch config/deploy/staging.rb
touch config/deploy/production.rb
</code></pre></li>
<li><p>Capistrano共通のデプロイ設定</p>

<pre><code>config/deploy.rb
</code></pre></li>
<li><p>Capistrano Staging環境のデプロイ設定</p>

<pre><code>config/deploy/staging.rb
</code></pre></li>
<li><p>Capistrano Producion環境のデプロイ設定</p>

<pre><code>config/deploy/production.rb
</code></pre></li>
<li><p>メンテナンス画面の設定</p>

<pre><code>config/maintenace.yml
</code></pre></li>
<li><p>DB設定</p>

<pre><code>database.yml
</code></pre></li>
<li><p>デプロイ前のチェックリスト</p></li>
<li>deploy.rb, staging.rb, production.rbのパラメータをすべて設定したかチェック</li>
<li>ステージングDB、本番DBの設定をdatabase.ymlに追加しているか？</li>
<li>デプロイ用Gitリポジトリのブランチが最新の状態か？</li>
<li><p>デプロイ手順</p>

<pre><code>cap staging deploy:setup
cap staging deploy
cap production deploy:setup
cap production deploy
</code></pre></li>
<li><p>Apachバーチャルホストを設定</p>

<pre><code>sudo vi /etc/httpd/conf/httpd.conf
#ServerName centossrv.com:80行頭に#を追加してコメントアウト
NameVirtualHost *:80コメント解除(バーチャルホスト有効化)
sudo vi /etc/httpd/conf.d/vhost.conf
&lt;VirtualHost *:80&gt;
  &lt;Location /&gt;
    &lt;IfModule mod_deflate.c&gt;
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        Header append Vary User-Agent env=!dont-vary
    &lt;/IfModule&gt;
  &lt;/Location&gt;
  ServerName hcoss.dev.k2-works.net
  ServerAlias *.dev.k2-works.net
  DocumentRoot var/rails/hcoss/current/public
  RailsEnv production
  PassengerEnabled on
  RemoveHandler .cgi .php
&lt;/VirtualHost&gt;


[サーバーの準備（CentOS 6.2編）]: http://www.oiax.jp/rails3book/prepare_centos_6_2.html
[さくらVPS/CentOS 6.3 Ruby 1.93/RVMのインストール手順Railsサーバへの道]: http://morizyun.github.io/blog/rvm-install-centos-ruby-rails/
[Amazon RDS 文字化けと格闘]: http://www.teps4545.com/2010/01/amazon-rds.html
[Rails本番環境構築ガイド]: http://www.oiax.jp/rails3book/deploy.html
[Capistrano 複数環境へのデプロイ]: http://morizyun.github.io/blog/capistrano-localhost-multi-deploy/
</code></pre></li>
</ul>

<h4>6.4.2) 本番環境の構築</h4>

<ul>
<li><p>サーバーの準備（Ubuntu Server 12.04 LTS編）  </p>

<p>[Rails本番環境構築ガイド]</p>

<pre><code>% sudo apt-get update
% sudo apt-get upgrade
% sudo apt-get install build-essential automake git
% sudo apt-get install zlib1g-dev libssl-dev libreadline6-dev
libyaml-dev libxml2-dev libxslt-dev
% sudo apt-get install libsqlite3-dev libcurl4-openssl-dev
% sudo apt-get install apache2 openssh-server apache2-prefork-dev libapr1-dev libaprutil1-dev
% sudo apt-get install imagemagick libmagickwand-dev
</code></pre></li>
<li><p>Ruby 1.9.3のインストール</p>

<pre><code>% mkdir ~/src
% cd ~/src
% wget [http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p392.tar.gz]
% tar xzf ruby-1.9.3-p392.tar.gz
% cd ruby-1.9.3-p392
% ./configure
% make
% sudo make install
</code></pre></li>
<li><p>Railsアプリケーションのセットアップ</p></li>
<li><p>railsユーザーの作成</p>

<pre><code> % sudo useradd -m -d /var/rails rails
 % sudo passwd rails
 % sudo chmod 750 /var/rails
</code></pre></li>
<li><p>Apache実行ユーザーをグループに追加</p>

<pre><code> % sudo gpasswd -a www-data rails
</code></pre></li>
<li><p>ApacheとPhusion Passengerのセットアップ</p></li>
<li><p>Phusion Passengerのインストール</p>

<pre><code> % sudo gem install passenger --no-ri --no-rdoc
 % sudo passenger-install-apache2-module
</code></pre></li>
<li><p>Apacheの準備</p>

<pre><code>% sudo -s
$ mkdir /var/www/html
$ cd /etc
$ ln -s apache2 httpd
$ cd httpd
$ echo "ServerName www.example.com:80" &gt;&gt; httpd.conf
</code></pre></li>
<li><p>Phusion PassengerをApacheに組み込む</p>

<pre><code>/etc/httpd/conf.d/passenger.conf
 LoadModule passenger_module /usr/local/lib/ruby/gems/1.9.1/gems/passenger-3.0.19/ext/apache2/mod_passenger.so              LoadModule passenger_module /usr/local/lib/ruby/gems/1.9.1/gems/passenger-3.0.19/ext/apache2/mod_passenger.so
 PassengerRoot /usr/local/lib/ruby/gems/1.9.1/gems/passenger-3.0.19
 PassengerRuby /usr/local/bin/ruby
</code></pre></li>
<li><p>バーチャルホストの追加</p>

<pre><code>/etc/httpd/sites-available/default 
&lt;VirtualHost *:80&gt;
  DocumentRoot /var/www/html
  &lt;Directory /var/www/html&gt;
    AllowOverride all
    Options None
    Order Deny,Allow
    Deny from All
  &lt;/Directory&gt;
&lt;/VirtualHost&gt;
/etc/httpd/sites-available/railsdemo
&lt;VirtualHost *:80&gt;
 ServerName [http://railsdemo.k2-works.net]
 DocumentRoot /var/rails/railsdemo/public
 RackEnv production
 &lt;Directory /var/rails/railsdemo/public&gt;
   AllowOverride all
   Options -MultiViews
 &lt;/Directory&gt;
&lt;/VirtualHost&gt;
$ ln -s /etc/httpd/sites-available/railsdemo/etc/httpd/sites-enabled/001-railsdemo


EC2ではバーチャルホストがうまくいかない
[http://hivecolor.com/id/9]
Route53でサブドメインを設定しておく
</code></pre></li>
<li><p>Apacheの再起動</p>

<pre><code> $ service apache2 restart
</code></pre></li>
<li><p>データベースとの接続（MySQL編）</p></li>
<li><p>MySQLサーバのセットアップ</p>

<pre><code>パスワード
gnDwPsFVM5kMU (root)
diiNv2bid4aTI (railsdemo)
% sudo -s
% echo "gnDwPsFVM5kMU" &gt; /root/mysql_root_password
% echo "diiNv2bid4aTI" &gt; /root/mysql_railsdemo_password
% chmod 400 /root/mysql_*_password
% exit
MySQLを初期化します。
% sudo mysql_install_db
</code></pre></li>
<li><p>データベースおよびユーザーの作成</p>

<pre><code>mysql -u root コマンドでMySQLモニターを開きます。
$ show databases;
rootユーザーのパスワードを変更します。
$ SET PASSWORD FOR 'root'@'localhost' = PASSWORD('gnDwPsFVM5kMU');
railsdemo_productionデータベースを作り、railsdemoユーザーに全権を与えます。
$ CREATE DATABASE railsdemo_production DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
$ GRANT ALL ON railsdemo_production.* TO 'railsdemo'@'localhost';
$ SET PASSWORD FOR 'railsdemo'@'localhost' = PASSWORD('diiNv2bid4aTI');               
MySQLモニターを抜けます。
$ quit
</code></pre></li>
<li><p>データベース接続の切り替え</p>

<pre><code>% sudo su - rails
% cd railsdemo
エディタで Gemfile を開き、
gem 'sqlite3'
を
gem 'mysql2'
に変更します。そして、Bundlerでmysql2ライブラリをインストールします。
% bundle install
config/database.yml
production:
 adapter: mysql2
 database: railsdemo_production
 username: railsdemo
 password: diiNv2bid4aTI
 host: 127.0.0.1
 encoding: utf8
% RAILS_ENV=production rake db:schema:load
% RAILS_ENV=production rake db:seed
</code></pre></li>
<li><p>Railsアプリケーションの再起動</p>

<pre><code>% touch tmp/restart.txt
</code></pre></li>
<li><p>日本語対応</p>

<pre><code>[Amazon RDS 文字化けと格闘]
mysql&gt; alter railsdemo_production mydb default character set utf8;
mysql&gt; show variables like '%character%';
railsユーザーになってサイドDB migrateb% RAILS_ENV=production rake db:schema:load
% RAILS_ENV=production rake db:seed
</code></pre></li>
<li><p>Gitレポジトリの作成</p></li>
<li><p>Gitレポジトリの作成</p>

<pre><code>まずリモートマシンにgitユーザーを作成します。
$ sudo useradd -m -d /var/git git
$ sudo passwd git
$ sudo chmod 750 /var/git
railsユーザーをgitグループに加えます。/var/gitディレクトリの読み取り権限が与えられることになります。
$ sudo gpasswd -a rails git
ローカルマシンからあなたのSSH公開鍵をgitユーザーのホームディレクトリに転送します。
% scp -i k2works.pm .ssh/id_rsa.pub ubuntu@:54.248.228.199:~
SSH公開鍵をauthorized_keysに加えます。
$ mkdir -m 700 .ssh
$ cat id_rsa.pub &gt;&gt; .ssh/authorized_keys
$ chmod 600 .ssh/authorized_keys
$ rm id_rsa.pub
空のレポジトリ asagao.git を作成します。
$ mkdir railsdemo.git
$ git init --bare --shared=0640 railsdemo.git
</code></pre></li>
<li><p>レポジトリにソースコードを登録</p>

<pre><code>ローカルマシンのrailsdemoディレクトリに移動して、以下のコマンドを順に実行します。
% git init
% git add .
% git commit -m 'initial commit'
% git remote add origin git@railsdemo.k2-works.net:railsdemo.git
% git push origin master
</code></pre></li>
<li><p>Capistranoによるデプロイ</p></li>
<li><p>本番・ステージング環境の設定</p>

<pre><code>[Capistrano 複数環境へのデプロイ]
</code></pre></li>
<li><p>staging/production環境のデータベースの準備</p></li>
<li>Gemfileの追加</li>
<li>Capistranoの設定フィルを生成</li>
<li>Capistrano共通のデプロイ設定</li>
<li>Capistrano Staging環境のデプロイ設定</li>
<li>Capistrano Producion環境のデプロイ設定</li>
<li>メンテナンス画面の設定</li>
<li>デプロイ前のチェックリスト</li>
<li>デプロイ手順</li>
<li>Apachバーチャルホストを設定</li>
<li><p>SSH公開鍵の設置</p>

<pre><code>$ sudo mkdir --mode=700 var/rails.ssh
$ sudo cp home/k2works.ssh/authorized_keys var/rails.ssh/
$ sudo chown -R rails:rails var/rails.ssh
</code></pre>

<p>ローカルマシンからrailsユーザーとしてSSHで接続し、パスワードを尋ねられないことを確認します。</p>

<pre><code>% ssh rails@railsdemo.k2-works.net
</code></pre></li>
<li><p>Capistranoの準備</p>

<pre><code> % gem install capistrano
 % capify .
 config/deploy.rb
 require 'bundler/capistrano'
 load 'deploy/assets'
 set :application, "railsdemo"
 set :deploy_to, "/var/rails/railsdemo"
 set :user, "rails"
 set :use_sudo, false
 set :local_repository, "git@demo.k2-works.net:railsdemo.git"
 set :repository, "/var/git/railsdemo.git"
 set :branch, "master"
 set :scm, :git
 set :deploy_via, :remote_cache
 set :normalize_asset_timestamps, false
 set :keep_releases, 3
 role :web, "demo.k2-works.net"
 role :app, "demo.k2-works.net"
 role :db,  "demo.k2-works.net", :primary =&gt; true
 after "deploy:update", :roles =&gt; :app do
   run "cp #{shared_path}/config/database.yml
 #{release_path}/config/"
 end
 after "deploy:update", "deploy:cleanup"
 namespace :deploy do
   desc "Restarts your application."
   task :restart, :roles =&gt; :app do
     run "touch #{current_path}/tmp/restart.txt"
   end
 end
次のコマンドを実行します
 % cap deploy:setup
 エディタで Gemfile を開き、gem 'sqlite3' の部分を gem 'mysql2' あるいは gem 'pg' と書き換えます。また、
 # gem 'therubyracer'
 を次のように書き換えます。
 gem 'therubyracer', :platform =&gt; :ruby
 $bundle install
 railsユーザーでリモートホストにログインして以下のコマンドを順に実行します。
 $ cd /var/rails/railsdemo/shared
 $ mkdir config
</code></pre>

<p>MySQLを利用している場合は、新規ファイル
   /var/rails/railsdemo/shared/config/database.yml を次の内容で作成します。</p>

<pre><code> production:
   adapter: mysql2
   database: railsdemo_production
   username: railsdemo
   password: diiNv2bid4aTI
   host: railsdemo.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com                                  host: railsdemo.ccebcwxdebti.ap-northeast-1.rds.amazonaws.com
   encoding: utf8
 $ cap deploy
</code></pre></li>
<li><p>仮想ホストの設定変更</p>

<pre><code>        sudo権限のあるユーザー(kuroda)でリモートホストにログインして、/etc/httpd/sites-available/railsdemo を次のように修正します（要sudo）。                            sudo権限のあるユーザー(kuroda)でリモートホストにログインして、/etc/httpd/sites-available/railsdemo を次のように修正します（要sudo）。
        &lt;VirtualHost *:80&gt;
        ServerName asagao.oiax.jp
        DocumentRoot /var/rails/railsdemo/current/public
        RackEnv production
        &lt;Directory /var/rails/railsdemo/current/public&gt;
        AllowOverride all
        Options -MultiViews
        &lt;/Directory&gt;
        &lt;/VirtualHost&gt;
        パスの /public の前に current を追加しています（2カ所）。
        そして、Apacheをリロードします。
         $ sudo service apache2 reload # Ubuntu Server 12.04/10.04
       LTS の場合               
         [Rails本番環境構築ガイド]: [http://www.oiax.jp/rails3book/deploy.html]                              [Rails本番環境構築ガイド]: [http://www.oiax.jp/rails3book/deploy.html]
         [知っておきたいApacheの基礎知識 その1]:
       [http://gihyo.jp/admin/serial/01/unix/0005]
         [Amazon RDS 文字化けと格闘]: [http://www.teps4545.com/2010/01/amazon-rds.html]                              [Amazon RDS 文字化けと格闘]: [http://www.teps4545.com/2010/01/amazon-rds.html]
         [Capistrano 複数環境へのデプロイ]:
       [http://morizyun.github.io/blog/capistrano-localhost-multi-deploy/]


<pre><code>   [Rails本番環境構築ガイド]: http://www.oiax.jp/rails3book/deploy.html
</code></pre>

</code></pre></li>
</ul>

<h2>7) CI環境の構築</h2>

<h3>7.1) 自動テスト</h3>

<h4>7.1.1) Railsプロジェクトの作成</h4>

<ul>
<li><p>node.jsインストール</p>

<p>[Mac OS X と homebrew なら驚くほど簡単に node.js で HelloWorld]
   $ruby -e "$(curl -fsSkL raw.github.com/mxcl/homebrew/go)"
   $brew install node</p></li>
<li><p>Railsのインストール     </p></li>
<li><p>RSpecのインストール</p>

<p>[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル]
   Gemfile
   group :test, :development do
     gem 'rspec-rails', '~>2.0'
   end
   $bundle install
   $rails generate rspec:install
   $rake db:create
   $rake db:migrate
   $rake spec</p>

<p>[Mac OS X と homebrew なら驚くほど簡単に node.js で HelloWorld]: http://takatamajp.wordpress.com/2012/11/17/install<em>nodejs</em>on<em>mac</em>os<em>x</em>using_homebrew/
   [これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル]: http://qiita.com/items/bf1bc376d88186050f3f</p></li>
</ul>

<h4>7.1.2) Capybara-webkitのインストール</h4>

<ul>
<li><p>QTライブラリのインストール</p>

<p>[RSpecとCapybaraでJavaScript/Ajaxをテストする] <br />
   $brew install qt</p></li>
<li><p>Capybara-webkitのインストール</p>

<p>Mac環境ではheadlessはいらない
   サーバーにはインストールすること</p></li>
<li><p>CentOS6.3の場合</p>

<pre><code> [Installing Qt and compiling capybara webkit]
 [CentOS6.3 の Jenkins 上で jasmine-headless-webkit を走らせる]
 rpm -i [http://dl.atrpms.net/el6-x86\_64/atrpms/stable/atrpms-repo-6-6.el6.x86\_64.rpm]              rpm -i [http://dl.atrpms.net/el6-x86\_64/atrpms/stable/atrpms-repo-6-6.el6.x86\_64.rpm]
 yum install --enablerepo=atrpms-testing qt47-webkit-devel
 export QMAKE=/usr/bin/qmake-qt47
 cd /usr/bin
 sudo ln -s qmake-qt47 qmake
 sudo ln -s qmake-qt47 qmake-qt4
 group :test, :development do
 gem 'rspec-rails','~&gt;2.0'
 gem 'database_cleaner'
 end 
 group :test do
 gem 'headless'
 gem 'capybara-webkit'
 end 
 $bundle install
 spec/spec_helper.rb
 config.before(:suite) do
   DatabaseCleaner.strategy = :truncation
   DatabaseCleaner.clean_with(:truncation)
 end
 config.before(:each) do
  DatabaseCleaner.start
 end
 config.after(:each) do
  DatabaseCleaner.clean
 end
 Capybara.javascript_driver = :webkit
 $ rake spec
</code></pre>

<p>[RSpecとCapybaraでJavaScript/Ajaxをテストする]: http://www.oiax.jp/rails/zakkan/testing<em>javascript</em>with<em>rspec</em>and<em>capybara.html
   [Installing Qt and compiling capybara webkit]: https://github.com/thoughtbot/capybara-webkit/wiki/Installing-Qt-and-compiling-capybara-webkit
   [CentOS6.3 の Jenkins 上で jasmine-headless-webkit を走らせる]: http://tomykaira.hatenablog.com/entry/2012/07/27/103122
   [http://dl.atrpms.net/el6-x86_64/atrpms/stable/atrpms-repo-6-6.el6.x86_64.rpm]: http://dl.atrpms.net/el6-x86</em>64/atrpms/stable/atrpms-repo-6-6.el6.x86_64.rpm</p></li>
</ul>

<h4>7.1.3) テストサーバー</h4>

<ul>
<li><p>Sport</p>

<p>[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル（その２）]</p>

<pre><code>$ vim Gemfile
Gemfile
group :test, :development do
gem 'rspec-rails','~&gt;2.0'
gem 'database_cleaner'
gem 'spork','0.9.2'
end  
spork --bootstrap
$ vim spec/spec_helper.rb
</code></pre>

<p>一通りSpork.prefork do・・・endに入れる</p>

<pre><code>require 'rubygems'
require 'spork'
#uncomment the following line to use spork with the debugger
#require 'spork/ext/ruby-debug'
Spork.prefork do
# Loading more in this block will cause your tests to run faster.
 However,
# if you change any configuration or code from libraries loaded here,
</code></pre>

<p>you'll</p>

<h1>need to restart spork for it take effect.</h1>

<h1>This file is copied to spec/ when you run 'rails generate</h1>

<p>rspec:install'
ENV["RAILS<em>ENV"] ||= 'test'
require File.expand</em>path("../../config/environment", FILE
require 'rspec/rails'
require 'rspec/autorun'</p>

<h1>Requires supporting ruby files with custom matchers and macros, etc,</h1>

<h1>in spec/support/ and its subdirectories.</h1>

<p>Dir[Rails.root.join("spec/support/<em>*/</em>.rb")].each {|f| require f}
RSpec.configure do |config|</p>

<h1>## Mock Framework</h1>

<p>#</p>

<h1>If you prefer to use mocha, flexmock or RR, uncomment the appropriate</h1>

<p>line:
#</p>

<h1>config.mock_with :mocha</h1>

<h1>config.mock_with :flexmock</h1>

<h1>config.mock_with :rr</h1>

<h1>Remove this line if you're not using ActiveRecord or ActiveRecord</h1>

<p>fixtures
config.fixture_path = "#{::Rails.root}/spec/fixtures"</p>

<h1>If you're not using ActiveRecord, or you'd prefer not to run each of</h1>

<p>your</p>

<h1>examples within a transaction, remove the following line or assign</h1>

<p>false</p>

<h1>instead of true.</h1>

<p>config.use<em>transactional</em>fixtures = true</p>

<h1>If true, the base class of anonymous controllers will be inferred</h1>

<h1>automatically. This will be the default behavior in future versions of</h1>

<h1>rspec-rails.</h1>

<p>config.infer<em>base</em>class<em>for</em>anonymous<em>controllers = false
end
end
Spork.each</em>run do</p>

<h1>This code will be run each time you run your specs.</h1>

<p>end
$ vim .rspec
.rspec</p></li>
<li><p>-colour</p></li>
<li><p>-drb</p>

<p>$ spork       </p>

<p>[これからテストを書き始めたい人のための Rails+RSpec+Spork+FactoryGirl チュートリアル（その２）]: http://qiita.com/items/fbe0a4ac2269a743dc17</p></li>
</ul>

<h4>7.1.4) jenkinsのインストール</h4>

<pre><code>  Jenkins Update
  [http://d.hatena.ne.jp/tadasy/20111109/1320842690]
  [http://shogogg.hatenablog.jp/entry/20120410/1334048401]
  wget [http://mirrors.jenkins-ci.org/war/latest/jenkins.war]
  sudo service jenkins stop
  sudo rm usr/lib/jenkins/jenkins.war     sudo mv jenkins.war
/usr/lib/jenkins
  sudo service jenkins start
</code></pre>

<h4>7.1.5) RailsをビルドするためのJenkinsセットアップ</h4>

<ul>
<li><p>RVMの設定</p>

<p>[Ubuntu Server 12.04 LTS + RVM + ruby1.9 + Rails3の環境を構築してみた]</p></li>
<li><p>RVMのインストール</p>

<p>[さくらVPS/CentOS 6.3 Ruby 1.93/RVMのインストール手順Railsサーバへの道]
  bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )        bash -s stable &lt; &lt;(curl -s [https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer] )
  rvm pkg install libyaml
  rvm remove 1.9.1 <br />
  rvm install ruby-1.9.3 -C --with-opt-dir=$HOME/.rvm/usr    </p></li>
<li><p>Git Plugin</p></li>
<li>RVM Plugin</li>
<li>Rake Plugin</li>
<li>Jenkins及びプラグインの設定</li>
<li>gitの設定</li>
<li>Git pluginの設定</li>
<li>Rakeの設定（空欄のまま）</li>
<li>E-mail通知の設定</li>
</ul>

<h4>7.1.6) Railsをビルドするジョブを作成する</h4>

<pre><code>  [Jenkins@さくらVPSにOctopressのデプロイを任せてみる]
  cp .ssh/known_hosts var/lib/jenkins.ssh/
</code></pre>

<ul>
<li>Rake Pluginを使ってビルドする</li>
<li><p>シェルスクリプトを使ってビルドする</p>

<p>gem install bundle --no-ri --no-rdoc
   bundle install
   rake db:setup
   rake spec</p>

<p>[Jenkins@さくらVPSにOctopressのデプロイを任せてみる]: http://www.tokoro.me/2012/07/29/jenkins-octopress/    </p></li>
</ul>

<h3>7.2) コードインスペクション</h3>

<h4>7.2.1) コードカバレッジ分析</h4>

<ul>
<li><p>Gemをインストールする</p>

<p>group :test do
    #ローカル開発では使わない
    # gem 'headless'
    gem 'capybara-webkit'
    gem 'simplecov', :require => false
    gem 'simplecov-rcov', :require => false
   end</p></li>
<li><p>spec/spec_helpler.rbの頭に追加</p>

<p>require 'simplecov'
   require 'simplecov-rcov'
   SimpleCov.formatter = SimpleCov::Formatter::RcovFormatter
   SimpleCov.start 'rails'</p></li>
<li><p>.gitignoreにcoverage追加</p></li>
<li><p>Ruby metrics plugin</p>

<p>ビルド後の処理の追加   </p></li>
</ul>

<h4>7.2.2) コード品質の検査</h4>

<ul>
<li><p>rails<em>best</em>practicesをGemに追加</p>

<p>group :test, :development do
    gem 'rspec-rails','~>2.0'
    gem 'database<em>cleaner'
    gem 'spork','0.9.2'
    gem 'rails</em>best_practices', :require => false
   end     </p></li>
<li><p>rails<em>bes</em>practices.sh追加</p></li>
<li><p>ビルド手順の追加からシェルの実行を追加</p>

<p>bash script/rails<em>best</em>paractices.sh</p></li>
<li><p>Plot Plugin</p>

<p>ビルド後の処理でビルドデータをプロットを追加</p></li>
<li><p>.gitignoreにreportsを追加</p></li>
</ul>

<h4>7.2.3) 重複コード（コピー＆ペースト）の検出</h4>

<pre><code>  [CentOSにAntをインストールする]
</code></pre>

<ul>
<li>pmdインストール     </li>
<li>sudo apt-get install ant</li>
<li>tools/build.xml追加</li>
<li><p>DRY Plugin</p>

<p>ビルド手順の追加からAntの呼び出しを追加
   ビルド後の処理に重複コード分析の集計を追加</p></li>
<li><p>.gitignoreへの追加</p>

<p>tools/pmd/doc</p>

<p>[CentOSにAntをインストールする]: http://blog.justoneplanet.info/2010/12/03/centos%E3%81%ABant%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B/</p></li>
</ul>

<h3>7.3) ドキュメント生成</h3>

<h4>7.3.1) Ruby,Railsでのドキュメント生成</h4>

<ul>
<li><p>YARDを使ってドキュメントを生成し、閲覧できるようにする</p>

<p>group :test, :development do
   gem 'rspec-rails','~>2.0'
   gem 'database<em>cleaner'
   gem 'spork','0.9.2'
   gem 'rails</em>best_practices', :require => false
   gem 'yard', :require => false
  end     </p></li>
<li><p>HTML Publisher Plugin</p>

<p>ビルド手順の追加からシェルの実行を選択して yard doc
   ビルド後の処理の追加からPublish HTML Reports追加</p></li>
</ul>

<h4>7.3.2) Ruby,Railsでのデプロイ</h4>

<ul>
<li>新しいジョブを作るblog_deploy</li>
<li>ソースコード管理システムはblogジョブと同様に設定する</li>
<li>ビルド・トリガセクション内で他のプロジェクトのビルド後にビルドにチェックを入れる</li>
<li>Run the build in a RVM-managed environmentもblogジョブと同様に設定しておく</li>
<li>ビルドのセクションではシェルスクリプトの実行を選びcap deployを入力する** デプロイ</li>
</ul>

<h3>7.4) 分散ビルド</h3>

<ul>
<li>自動テストとコードインスペクションの分割</li>
<li>自動テストの種類での分割</li>
<li><p>ビルドフローの起点の設定とフローに潜む問題の解決</p>

<p>Jenkins Parameterized Trigger plugin
  Join plugin
  Build Pipeline Plugin</p></li>
</ul>

</body>
</html>
