<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>2013-09-04-154417.html</title>

</head>

<body>

<p>= ruby-profを使ってRailsアプリケーションのプロファイリングをする
[2013-09-04 15:44] </p>

<h1>目的</h1>

<p>アプリケーションのパフォーマンスボトルネックを洗い出し改善する。</p>

<h1>前提</h1>

<p>| ソフトウェア     | バージョン    | 備考        |
|:---------------|:-------------|:------------|
| Ruby           |1.9.3p392     |       |
| Rails          |3.2.13        |       |
| sqlite3        |3.7.16.2      |       |
| ruby-prof      |0.13.0        |       |</p>

<h1>構成</h1>

<ul>
<li><a href="#section1">railsアプリの構築</a></li>
<li><a href="#section2">railsアプリのプロファイリング</a></li>
<li><a href="#section3">プロファイリング結果を分析する</a></li>
<li><a href="#section4">mysqlを使ったプロファイリング環境</a></li>
</ul>

<h1>詳細</h1>

<h2><a name="section1">railsアプリの構築</h2>

<pre><code>bash-3.2$ rails g scaffold blog title:string body:text
  invoke  active_record
  create    db/migrate/20130904061215_create_blogs.rb
  create    app/models/blog.rb
  invoke    test_unit
  create      test/unit/blog_test.rb
  create      test/fixtures/blogs.yml
  invoke  resource_route
   route    resources :blogs
  invoke  scaffold_controller
  create    app/controllers/blogs_controller.rb
  invoke    erb
  create      app/views/blogs
  create      app/views/blogs/index.html.erb
  create      app/views/blogs/edit.html.erb
  create      app/views/blogs/show.html.erb
  create      app/views/blogs/new.html.erb
  create      app/views/blogs/_form.html.erb
  invoke    test_unit
  create      test/functional/blogs_controller_test.rb
  invoke    helper
  create      app/helpers/blogs_helper.rb
  invoke      test_unit
  create        test/unit/helpers/blogs_helper_test.rb
  invoke  assets
  invoke    coffee
  create      app/assets/javascripts/blogs.js.coffee
  invoke    scss
  create      app/assets/stylesheets/blogs.css.scss
  invoke  scss
  create    app/assets/stylesheets/scaffolds.css.scss

bash-3.2$ rake db:migrate
==  CreateBlogs: migrating ====================================================
-- create_table(:blogs)
-&gt; 0.0012s
==  CreateBlogs: migrated (0.0012s) ===========================================
</code></pre>

<h2><a name="section2">railsアプリのプロファイリング</h2>

<h3>profile.rbを作成する</h3>

<p>profile_test/config/environments/profile.rb</p>

<pre><code>ProfileTest::Application.configure do
    # Settings specified here will take precedence over those in config/application.rb

    # In the development environment your application's code is reloaded on
      # every request. This slows down response time but is perfect for development
      # since you don't have to restart the web server when you make code changes.
      config.cache_classes = true
      config.cache_template_loading = true

      # Log error messages when you accidentally call methods on nil.
      config.whiny_nils = true

      # Show full error reports and disable caching
      config.consider_all_requests_local       = true
      config.action_controller.perform_caching = true

      # Don't care if the mailer can't send
      config.action_mailer.raise_delivery_errors = false

      # Print deprecation notices to the Rails logger
      config.active_support.deprecation = :log

      # Only use best-standards-support built into browsers
      config.action_dispatch.best_standards_support = :builtin

      # Raise exception on mass assignment protection for Active Record models
      config.active_record.mass_assignment_sanitizer = :strict

      # Log the query plan for queries taking more than this (works
      # with SQLite, MySQL, and PostgreSQL)
      config.active_record.auto_explain_threshold_in_seconds = 0.5

      # Do not compress assets
      config.assets.compress = false

      # Expands the lines which load the assets
      config.assets.debug = true
    end
</code></pre>

<h3>gemfileを編集する</h3>

<pre><code>group :profile do
  gem 'ruby-prof'
end
</code></pre>

<h3>config.ruを編集する</h3>

<pre><code>if Rails.env.profile?
  use Rack::RubyProf, :path =&gt; 'temp/profile'
end
</code></pre>

<p>/temp/profileと指定するとファイルの絶対パスを指定することになりファイルが見つからないエラーが出る。</p>

<p>相対パスでRailsのプロジェクト内に配置したい場合は上記のファイルパス指定とする。</p>

<h3>database.ymを編集する</h3>

<p>profile_test/config/database.yml</p>

<pre><code>profile:
  adapter: sqlite3
  database: db/development.sqlite3
  pool: 5
  timeout: 5000
</code></pre>

<p>念のため以下の処理も実行しておく</p>

<pre><code>bash-3.2$ rake db:migrate RAILS_ENV=profile
</code></pre>

<h3>その他</h3>

<p>アセットパイプラインのためにプリコンパイル済みのアセットを作成しておく</p>

<pre><code>$ bundle exec rake assets:precompile RAILS_ENV=profile
</code></pre>

<h3>railsをprofile環境で起動する</h3>

<pre><code>bash-3.2$ rails s -e profile
</code></pre>

<h2><a name="section3">プロファイリング結果を分析する</h2>

<h3>KCachegrindをインストールする。</h3>

<p>Macの場合MacPortを使ってインストールする。</p>

<p>brewを使う場合はqcachegrindをインストールする。</p>

<p>qtも必要なのでなければ一緒にインストールする。</p>

<pre><code>bash-3.2$ brew install qcachegrind at

bash-3.2$ qcachegrind
</code></pre>

<h3>Graphvizのインストール確認</h3>

<pre><code>bash-3.2$ which dot
/usr/local/bin/dot
</code></pre>

<p>なければインストール</p>

<pre><code>bash-3.2$ brew install graphviz
</code></pre>

<h3>KCachegrindに読み込ませるCallTreeファイルを出力するようにする</h3>

<p>profile_test/config.ru</p>

<pre><code>if Rails.env.profile?
    use Rack::RubyProf, :path =&gt; 'tmp/profile', :printers =&gt; {RubyProf::CallTreePrinter =&gt; 'Callgrid.out'}
end
</code></pre>

<h3>出力されたblogs-Callgrid.outファイルをKCachegrindに読み込ませる</h3>

<h2><a name="section4">Mysqlを使ったプロファル環境</h2>

<h3>MySQLをインストールする</h3>

<pre><code>$ brew install mysql

$ mysql_install_db --verbose --user=`k2works` --basedir="$(brew --prefix mysql)" --datadir=/usr/local/var/mysql --tmpdir=/tmp

$mysql.server start

$ mysql 

$ bash$/usr/local/opt/mysql/bin/mysql_secure_installation
</code></pre>

<h3>データベースを作る</h3>

<pre><code>MacBook-Air:~:-bash$mysql -u root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 14
Server version: 5.6.10 Source distribution

Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; CREATE DATABASE hcoss_profile DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
Query OK, 1 row affected (0.00 sec)

mysql&gt; alter database hcoss_profile default character set utf8;
Query OK, 1 row affected (0.00 sec)
</code></pre>

<h3>database.ymlを更新する</h3>

<pre><code>profile:
  adapter: mysql2
  database: hcoss_profile
  username: root
  password: root
  host: localhost
  encoding: utf8
</code></pre>

<h3>マイグレーションを実行する</h3>

<pre><code>$ rake db:migrate RAILS_ENV=profile

$ rake db:seed RAILS_ENV=profile

$ rails s -e profile
</code></pre>

<h3>MiniProfiler/Ruby導入</h3>

<p>Gemfileに追加</p>

<pre><code>group :profile do
  # プロファイリング
  gem 'rack-mini-profiler'  
  gem 'ruby-prof'
 end
</code></pre>

<h1>参照</h1>

<p><a href="https://github.com/ruby-prof/ruby-prof">ruby-prof/ruby-prof</a></p>

<p><a href="http://blog.mirakui.com/entry/20100919/rubyprof">ruby-profとKCacheGrindでプロファイル野郎になる</a></p>

<p><a href="http://dpaluy.github.io/blog/2013/04/09/profiling-rails-applications/#ruby-prof">Profiling Rails Applications</a></p>

<p><a href="http://d.hatena.ne.jp/tetsuyai/20110920/1316504421">プリコンパイル済みのアセットを作成する</a></p>

<p><a href="http://d.hatena.ne.jp/shigemk2/20120323/1332433728">Homebrewを利用してKCachegrind(QCachegrind)をインストールし、PHPで使えるようにする</a></p>

<p><a href="http://99blues.dyndns.org/blog/2010/07/kcachegrind/">KCachegrindを使ったコード改善</a></p>

<p><a href="http://tukaikta.blog135.fc2.com/blog-entry-197.html">HomebrewでMySQLをインストールする時に知っておきたいこと</a></p>

<p><a href="http://d.hatena.ne.jp/yutakikuchi/20110210/1297343942">Mysqlの起動に関するメモAdd Star</a></p>

<p><a href="http://qiita.com/yaotti/items/f6ab4cf3c8541fc4da83">Railsアプリのパフォーマンスチューニング用ツール紹介</a></p>

<p><a href="http://d.hatena.ne.jp/japanrock_pg/20110704/1309776724">first time to use ruby-profAdd Star</a></p>

</body>
</html>
